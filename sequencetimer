import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Play, Pause, Square, Plus, Trash2, ArrowUp, ArrowDown, RotateCcw, Volume2, VolumeX, Check, Save, FolderOpen, X } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp } from 'firebase/firestore';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const SequenceTimer = () => {
  // --- State ---
  const [timers, setTimers] = useState([
    { id: 1, label: 'Warm up', minutes: 0, seconds: 10 },
    { id: 2, label: 'Work', minutes: 20, seconds: 0 },
    { id: 3, label: 'Rest', minutes: 5, seconds: 0 },
  ]);
  
  const [mode, setMode] = useState('edit'); // 'edit', 'running', 'complete'
  const [activeTimerIndex, setActiveTimerIndex] = useState(0);
  const [timeLeft, setTimeLeft] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [isMuted, setIsMuted] = useState(false);

  // Persistence State
  const [user, setUser] = useState(null);
  const [savedSequences, setSavedSequences] = useState([]);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [showLoadModal, setShowLoadModal] = useState(false);
  const [sequenceName, setSequenceName] = useState('');
  
  const timerRef = useRef(null);
  const audioContextRef = useRef(null);

  // --- Auth & Persistence Logic ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    
    // Strict path: /artifacts/{appId}/users/{userId}/sequences
    const sequencesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'sequences');
    
    const unsubscribe = onSnapshot(sequencesRef, (snapshot) => {
      const seqs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sort in memory (Rule 2: No complex queries) - Newest first
      seqs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      setSavedSequences(seqs);
    }, (error) => {
      console.error("Error fetching sequences:", error);
    });

    return () => unsubscribe();
  }, [user]);

  const saveSequence = async () => {
    if (!sequenceName.trim() || !user) return;
    
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'sequences'), {
        name: sequenceName,
        timers: timers,
        createdAt: serverTimestamp()
      });
      setShowSaveModal(false);
      setSequenceName('');
    } catch (error) {
      console.error("Error saving sequence:", error);
    }
  };

  const loadSequence = (sequence) => {
    setTimers(sequence.timers);
    setShowLoadModal(false);
    setMode('edit');
  };

  const deleteSequence = async (id, e) => {
    e.stopPropagation();
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'sequences', id));
    } catch (error) {
      console.error("Error deleting sequence:", error);
    }
  };

  // --- Audio Logic (Web Audio API) ---
  const playChime = useCallback(() => {
    if (isMuted) return;

    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
    }
    const ctx = audioContextRef.current;
    
    // Create oscillator
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    osc.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    // Bell sound settings
    osc.type = 'sine';
    osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
    osc.frequency.exponentialRampToValueAtTime(261.63, ctx.currentTime + 1.5); // Drop to C4
    
    gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.5);
    
    osc.start();
    osc.stop(ctx.currentTime + 1.5);
  }, [isMuted]);

  // --- Timer Logic ---
  const startSequence = () => {
    if (timers.length === 0) return;
    
    // Initialize audio context on user interaction
    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
    }

    if (mode === 'edit' || mode === 'complete') {
      setMode('running');
      setActiveTimerIndex(0);
      const firstTimer = timers[0];
      setTimeLeft(firstTimer.minutes * 60 + firstTimer.seconds);
    }
    setIsRunning(true);
  };

  const pauseSequence = () => {
    setIsRunning(false);
  };

  const stopSequence = () => {
    setIsRunning(false);
    setMode('edit');
    setActiveTimerIndex(0);
    setTimeLeft(0);
  };

  const skipTimer = () => {
    playChime();
    handleNextTimer();
  };

  const handleNextTimer = useCallback(() => {
    if (activeTimerIndex < timers.length - 1) {
      const nextIndex = activeTimerIndex + 1;
      setActiveTimerIndex(nextIndex);
      const nextTimer = timers[nextIndex];
      setTimeLeft(nextTimer.minutes * 60 + nextTimer.seconds);
    } else {
      setIsRunning(false);
      setMode('complete');
      // Play a special finished sound? (double chime)
      playChime();
      setTimeout(() => playChime(), 300);
    }
  }, [activeTimerIndex, timers, playChime]);

  useEffect(() => {
    if (isRunning && timeLeft > 0) {
      timerRef.current = setInterval(() => {
        setTimeLeft((prev) => prev - 1);
      }, 1000);
    } else if (isRunning && timeLeft === 0) {
      // Timer finished
      playChime();
      handleNextTimer();
    }

    return () => clearInterval(timerRef.current);
  }, [isRunning, timeLeft, handleNextTimer, playChime]);

  // --- Edit Logic ---
  const addTimer = () => {
    const newId = Math.max(...timers.map(t => t.id), 0) + 1;
    setTimers([...timers, { id: newId, label: 'New Timer', minutes: 1, seconds: 0 }]);
  };

  const updateTimer = (index, field, value) => {
    const newTimers = [...timers];
    newTimers[index] = { ...newTimers[index], [field]: value };
    setTimers(newTimers);
  };

  const removeTimer = (index) => {
    const newTimers = timers.filter((_, i) => i !== index);
    setTimers(newTimers);
  };

  const moveTimer = (index, direction) => {
    if (direction === 'up' && index > 0) {
      const newTimers = [...timers];
      [newTimers[index], newTimers[index - 1]] = [newTimers[index - 1], newTimers[index]];
      setTimers(newTimers);
    } else if (direction === 'down' && index < timers.length - 1) {
      const newTimers = [...timers];
      [newTimers[index], newTimers[index + 1]] = [newTimers[index + 1], newTimers[index]];
      setTimers(newTimers);
    }
  };

  // --- Formatting ---
  const formatTime = (secondsTotal) => {
    const mins = Math.floor(secondsTotal / 60);
    const secs = secondsTotal % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const getTotalDuration = () => {
    const totalSeconds = timers.reduce((acc, t) => acc + (parseInt(t.minutes || 0) * 60) + parseInt(t.seconds || 0), 0);
    return formatTime(totalSeconds);
  };

  // --- Components ---

  const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl animate-fadeIn">
          <div className="flex justify-between items-center p-4 border-b border-gray-100">
            <h3 className="font-bold text-gray-800">{title}</h3>
            <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full text-gray-500">
              <X size={20} />
            </button>
          </div>
          <div className="p-4">
            {children}
          </div>
        </div>
      </div>
    );
  };

  const EditView = () => (
    <div className="space-y-4 pb-20">
      <div className="flex justify-between items-center mb-2">
        <h2 className="text-xl font-bold text-gray-800">Sequence Editor</h2>
        <div className="flex gap-2">
          <button 
            onClick={() => setShowLoadModal(true)}
            className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex gap-1 items-center text-xs font-bold uppercase tracking-wide"
          >
            <FolderOpen size={16} /> Load
          </button>
          <button 
            onClick={() => setShowSaveModal(true)}
            className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex gap-1 items-center text-xs font-bold uppercase tracking-wide"
          >
            <Save size={16} /> Save
          </button>
        </div>
      </div>

      <div className="text-right text-xs font-medium text-gray-500 -mt-2 mb-4">
        Total Duration: {getTotalDuration()}
      </div>

      <div className="space-y-3">
        {timers.map((timer, index) => (
          <div key={timer.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row gap-3 items-center animate-fadeIn">
            <div className="flex flex-col gap-1 w-full sm:w-auto sm:flex-1">
              <label className="text-xs text-gray-400 font-bold uppercase tracking-wider">Label</label>
              <input
                type="text"
                value={timer.label}
                onChange={(e) => updateTimer(index, 'label', e.target.value)}
                className="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div className="flex gap-2 items-end">
              <div className="flex flex-col gap-1 w-16">
                 <label className="text-xs text-gray-400 font-bold uppercase tracking-wider">Min</label>
                 <input
                  type="number"
                  min="0"
                  value={timer.minutes}
                  onChange={(e) => updateTimer(index, 'minutes', Math.max(0, parseInt(e.target.value) || 0))}
                  className="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-center font-mono text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <span className="mb-2 font-bold text-gray-400">:</span>
              <div className="flex flex-col gap-1 w-16">
                <label className="text-xs text-gray-400 font-bold uppercase tracking-wider">Sec</label>
                <input
                  type="number"
                  min="0"
                  max="59"
                  value={timer.seconds}
                  onChange={(e) => updateTimer(index, 'seconds', Math.min(59, Math.max(0, parseInt(e.target.value) || 0)))}
                  className="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-center font-mono text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            <div className="flex gap-1 ml-auto pt-2 sm:pt-0">
               <button 
                onClick={() => moveTimer(index, 'up')}
                disabled={index === 0}
                className="p-2 text-gray-400 hover:text-blue-600 disabled:opacity-30 transition-colors"
               >
                 <ArrowUp size={18} />
               </button>
               <button 
                onClick={() => moveTimer(index, 'down')}
                disabled={index === timers.length - 1}
                className="p-2 text-gray-400 hover:text-blue-600 disabled:opacity-30 transition-colors"
               >
                 <ArrowDown size={18} />
               </button>
               <button 
                onClick={() => removeTimer(index)}
                className="p-2 text-gray-400 hover:text-red-500 transition-colors"
               >
                 <Trash2 size={18} />
               </button>
            </div>
          </div>
        ))}
      </div>

      <button
        onClick={addTimer}
        className="w-full py-3 mt-4 border-2 border-dashed border-gray-300 text-gray-500 rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 font-medium"
      >
        <Plus size={20} /> Add Timer
      </button>
    </div>
  );

  const RunningView = () => {
    const currentTimer = timers[activeTimerIndex];
    const totalCurrentDuration = (currentTimer.minutes * 60) + currentTimer.seconds;
    const progressPercent = totalCurrentDuration > 0 ? ((totalCurrentDuration - timeLeft) / totalCurrentDuration) * 100 : 0;

    return (
      <div className="flex flex-col h-full">
        {/* Active Timer Display */}
        <div className="flex-1 flex flex-col items-center justify-center py-8 relative">
          
          {/* Progress Ring Background */}
          <div className="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
             <div className="w-64 h-64 rounded-full bg-blue-500 transform scale-150 blur-3xl"></div>
          </div>

          <div className="z-10 text-center">
            <h3 className="text-2xl font-semibold text-gray-500 mb-2">{currentTimer.label}</h3>
            <div className="text-8xl font-mono font-bold text-gray-800 tracking-tighter mb-4 tabular-nums">
              {formatTime(timeLeft)}
            </div>
            <div className="text-sm font-medium text-gray-400 uppercase tracking-widest mb-8">
              Step {activeTimerIndex + 1} of {timers.length}
            </div>
            
            {/* Progress Bar */}
            <div className="w-64 h-2 bg-gray-200 rounded-full mx-auto overflow-hidden">
              <div 
                className="h-full bg-blue-600 transition-all duration-1000 ease-linear"
                style={{ width: `${progressPercent}%` }}
              ></div>
            </div>
          </div>
        </div>

        {/* Up Next List */}
        <div className="bg-gray-50 rounded-t-3xl p-6 shadow-inner flex-1 max-h-64 overflow-y-auto">
          <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Up Next</h4>
          <div className="space-y-3 opacity-60">
             {timers.slice(activeTimerIndex + 1).map((t, idx) => (
               <div key={idx} className="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-100">
                 <span className="font-medium text-gray-700">{t.label}</span>
                 <span className="font-mono text-gray-500">{formatTime((t.minutes * 60) + t.seconds)}</span>
               </div>
             ))}
             {timers.slice(activeTimerIndex + 1).length === 0 && (
               <div className="text-center text-gray-400 py-4 italic">End of sequence</div>
             )}
          </div>
        </div>
      </div>
    );
  };

  const CompleteView = () => (
    <div className="flex flex-col items-center justify-center h-full py-12 text-center animate-fadeIn">
      <div className="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-6">
        <Check size={48} strokeWidth={3} />
      </div>
      <h2 className="text-3xl font-bold text-gray-800 mb-2">Sequence Complete!</h2>
      <p className="text-gray-500 mb-8">All timers finished successfully.</p>
      
      <button
        onClick={stopSequence}
        className="px-8 py-3 bg-gray-800 text-white rounded-full font-medium hover:bg-gray-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
      >
        <RotateCcw size={20} /> Reset Sequence
      </button>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
      <div className="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[85vh] relative">
        
        {/* Modals */}
        <Modal isOpen={showSaveModal} onClose={() => setShowSaveModal(false)} title="Save Sequence">
          <div className="space-y-4">
            <input
              type="text"
              placeholder="e.g., Morning Yoga"
              value={sequenceName}
              onChange={(e) => setSequenceName(e.target.value)}
              className="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"
              autoFocus
            />
            <button
              onClick={saveSequence}
              disabled={!sequenceName.trim()}
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
            >
              Save Sequence
            </button>
          </div>
        </Modal>

        <Modal isOpen={showLoadModal} onClose={() => setShowLoadModal(false)} title="Load Sequence">
          {savedSequences.length === 0 ? (
            <p className="text-gray-500 text-center py-4">No saved sequences yet.</p>
          ) : (
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {savedSequences.map((seq) => (
                <div key={seq.id} className="flex items-center gap-2 p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-200 group cursor-pointer" onClick={() => loadSequence(seq)}>
                   <div className="flex-1">
                     <div className="font-bold text-gray-800">{seq.name}</div>
                     <div className="text-xs text-gray-400">{seq.timers?.length || 0} steps</div>
                   </div>
                   <button 
                    onClick={(e) => deleteSequence(seq.id, e)}
                    className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded transition-colors"
                   >
                     <Trash2 size={16} />
                   </button>
                </div>
              ))}
            </div>
          )}
        </Modal>

        {/* Header */}
        <div className="bg-white border-b border-gray-100 p-4 flex justify-between items-center z-20">
          <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
            Sequence Timer
          </h1>
          <button 
            onClick={() => setIsMuted(!isMuted)}
            className={`p-2 rounded-full ${isMuted ? 'text-gray-400 bg-gray-100' : 'text-blue-600 bg-blue-50'}`}
          >
            {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
          </button>
        </div>

        {/* Main Content Area */}
        <div className="flex-1 overflow-y-auto p-4 relative">
          {mode === 'edit' && <EditView />}
          {mode === 'running' && <RunningView />}
          {mode === 'complete' && <CompleteView />}
        </div>

        {/* Bottom Controls */}
        {mode !== 'complete' && (
          <div className="bg-white border-t border-gray-100 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
            {mode === 'edit' ? (
              <button
                onClick={startSequence}
                disabled={timers.length === 0}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-blue-200 shadow-lg hover:shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Play size={24} fill="currentColor" /> Start Sequence
              </button>
            ) : (
              <div className="grid grid-cols-4 gap-3">
                 <button
                  onClick={stopSequence}
                  className="col-span-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl flex items-center justify-center transition-colors"
                >
                  <Square size={20} fill="currentColor" />
                </button>

                <button
                  onClick={isRunning ? pauseSequence : startSequence}
                  className={`col-span-2 ${isRunning ? 'bg-amber-100 text-amber-600 hover:bg-amber-200' : 'bg-green-100 text-green-600 hover:bg-green-200'} py-3 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-colors`}
                >
                  {isRunning ? (
                    <><Pause size={24} fill="currentColor" /> Pause</>
                  ) : (
                    <><Play size={24} fill="currentColor" /> Resume</>
                  )}
                </button>

                 <button
                  onClick={skipTimer}
                  className="col-span-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl flex items-center justify-center transition-colors"
                  title="Skip Current Timer"
                >
                  <span className="text-xs font-bold">SKIP</span>
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default SequenceTimer;
